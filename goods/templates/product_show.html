{% extends "head_base.html" %}

{% block title %}{{ product.name }} - 商品详情{% endblock %}

{% block style %}
<style>
  .product-container {
    max-width: 1000px;
    margin: 30px auto;
    padding: 20px;
    border: 1px solid #eee;
    background: #fff;
  }

  .media-buttons {
    margin: 10px 0;
    text-align: center;
  }

  .media-buttons button {
    margin: 0 10px;
    padding: 8px 16px;
    cursor: pointer;
  }

  .media-display {
    text-align: center;
    margin-top: 20px;
  }

  .media-display img,
  .media-display video {
    max-width: 100%;
    height: auto;
    display: none;
    margin: 0 auto;
  }

  #model-container {
    width: 100%;
    height: 500px;
    margin: 0 auto;
    display: none;
  }

  .comments-section {
    margin-top: 40px;
    border-top: 1px solid #ccc;
    padding-top: 20px;
  }

  .comment {
    border-bottom: 1px solid #ddd;
    padding: 10px 0;
  }

  .pagination {
    margin-top: 15px;
    text-align: center;
  }

  .pagination a {
    margin: 0 5px;
    text-decoration: none;
    color: blue;
  }

  .comment-button {
    display: block;
    margin: 20px auto;
    padding: 10px 20px;
    background-color: #007bff;
    color: white;
    border: none;
    cursor: pointer;
  }

  .comment-button:hover {
    background-color: #0056b3;
  }
</style>
{% endblock %}

{% block content %}
<div class="product-container">
  <h2>{{ product.name }}</h2>
  <p>{{ product.description }}</p>

  <!-- 展示区 -->
  <div class="media-buttons">
    {% if product.image %}
      <button onclick="showMedia('image')">图片</button>
    {% endif %}
    {% if product.video %}
      <button onclick="showMedia('video')">视频</button>
    {% endif %}
    {% if product.tripo_3d_model %}
      <button onclick="showMedia('model')">3D 模型</button>
    {% endif %}
  </div>

  <div class="media-display" id="mediaDisplay">
    {% if product.image %}
      <img src="{{ product.image.url }}" id="mediaImage" style="display: block;">
    {% endif %}
    {% if product.video %}
      <video src="{{ product.video.url }}" id="mediaVideo" controls></video>
    {% endif %}
    {% if product.tripo_3d_model %}
      <div id="model-container"></div>
    {% endif %}
  </div>

  <!-- 评论按钮 -->
  <button class="comment-button" onclick="location.href='{% url 'goods:add_comment' product.id %}'">发表评论</button>
    <form method="post" action="{% url 'goods:add_comment' product.id %}">
      {% csrf_token %}
      <textarea name="text" rows="3" style="width: 100%;" placeholder="请输入评论..."></textarea><br>
      <button type="submit">提交评论</button>
    </form>

  <!-- 评论区 -->
  <div class="comments-section">
    <h3>用户评论</h3>
    {% for comment in comments %}
      <div class="comment">
        <strong>{{ comment.user.username }}</strong>：
        <p>{{ comment.text }}</p>
        <small>{{ comment.created_at }}</small>
      </div>
    {% empty %}
      <p>暂无评论</p>
    {% endfor %}

    <div class="pagination">
      {% if comments.has_previous %}
        <a href="?page={{ comments.previous_page_number }}">上一页</a>
      {% endif %}

      <span>第 {{ comments.number }} 页 / 共 {{ comments.paginator.num_pages }} 页</span>

      {% if comments.has_next %}
        <a href="?page={{ comments.next_page_number }}">下一页</a>
      {% endif %}
    </div>
  </div>
</div>

<!-- Three.js 和 OrbitControls 依赖 -->
<script src="https://cdn.jsdelivr.net/npm/three@0.150.1/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.150.1/examples/js/controls/OrbitControls.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.150.1/examples/js/loaders/GLTFLoader.js"></script>

<script>
  function showMedia(type) {
    const image = document.getElementById("mediaImage");
    const video = document.getElementById("mediaVideo");
    const model = document.getElementById("model-container");

    if (image) image.style.display = "none";
    if (video) video.style.display = "none";
    if (model) model.style.display = "none";

    if (type === "image" && image) image.style.display = "block";
    if (type === "video" && video) video.style.display = "block";
    if (type === "model" && model) {
      model.style.display = "block";
      if (!window.modelInitialized) {
        load3DModel();
        window.modelInitialized = true;
      }
    }
  }

  function load3DModel() {
    const container = document.getElementById("model-container");
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(container.clientWidth, container.clientHeight);
    renderer.setClearColor(0xf0f0f0);
    container.appendChild(renderer.domElement);

    const light = new THREE.HemisphereLight(0xffffff, 0x444444, 5);
    scene.add(light);

    const controls = new THREE.OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.dampingFactor = 0.05;

    const loader = new THREE.GLTFLoader();
    loader.load(
      "{{ product.tripo_3d_model.url }}",
      function(gltf) {
        console.log("模型加载成功！");
        gltf.scene.scale.set(2, 2, 2);
        scene.add(gltf.scene);
        camera.position.set(0, 1, 5);

        function animate() {
          requestAnimationFrame(animate);
          controls.update();
          renderer.render(scene, camera);
        }
        animate();
        alert("3D 模型加载成功！");
      },
      function(xhr) {
        console.log('加载进度: ' + (xhr.loaded / xhr.total * 100) + '%');
      },
      function(error) {
        console.error("加载3D模型时出错：", error);
        alert("加载3D模型失败，请检查文件路径或格式！");
      }
    );
  }
</script>
{% endblock %}
